import os

import yaml
from easydict import EasyDict
from rich import print
from memobase import MemoBaseClient, ChatBlob
from loguru import logger

class MemoBase:
    def __init__(
        self,
        token:str,
        user_id: str ="",
        url = "https://api.memobase.dev",
    ):
        self.client = MemoBaseClient(
            project_url=url,
            api_key=token,
        )
        assert self.client.ping(), "Your Memobase server is not running"
        try:
            self.user=self.client.get_user(user_id)
        except:
            self.user=self.create_user()
            
    def get_memory(self):
        return f"""{self.user.context()}"""
            
    def create_user(self,):
        logger.warning(f"Can not find user : {user_id}")
        user_id = self.client.add_user()
        user=self.client.get_user(user_id)
        logger.info(f"create user with id : {user_id} ")
        logger.warning(f"please save the id to config file")
        logger.info(f"init some dialogue into memobase")
        messages = [
            {
                "role": "user",
                "content": "ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹å°ç±³SU7å’Œæ¯”äºšè¿ªæ±‰è¿™ä¸¤æ¬¾æ–°èƒ½æºæ±½è½¦çš„å…·ä½“é…ç½®ï¼Œèƒ½å¸®æˆ‘è¯¦ç»†è¯´è¯´å—ï¼Ÿ",
            },
            {
                "role": "assistant",
                "content": "æ‚¨å¥½ï¼ŒWZHå…ˆç”Ÿï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼å°ç±³SU7æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„æ–°èƒ½æºæ±½è½¦ï¼Œå®ƒé…å¤‡äº†æœ€æ–°çš„æ™ºèƒ½é©¾é©¶è¾…åŠ©ç³»ç»Ÿï¼ŒåŒ…æ‹¬è‡ªé€‚åº”å·¡èˆªã€è‡ªåŠ¨æ³Šè½¦ç­‰åŠŸèƒ½ã€‚å®ƒçš„ç»­èˆªé‡Œç¨‹å¯ä»¥è¾¾åˆ°600å…¬é‡Œä»¥ä¸Šï¼Œè€Œä¸”å†…é¥°é‡‡ç”¨äº†çŽ¯ä¿ææ–™ï¼Œéžå¸¸èˆ’é€‚ã€‚æ¯”äºšè¿ªæ±‰åˆ™ä»¥å…¶å‡ºè‰²çš„ç”µæ± æŠ€æœ¯å’Œç¨³å®šçš„æ€§èƒ½è‘—ç§°ï¼Œç»­èˆªé‡Œç¨‹ä¹Ÿå¾ˆé«˜ï¼Œè¾¾åˆ°äº†700å…¬é‡Œå·¦å³ã€‚å®ƒçš„å¤–è§‚è®¾è®¡ä¹Ÿå¾ˆæ—¶å°šï¼Œå†…é¥°è±ªåŽï¼Œé…ç½®ä¹Ÿå¾ˆä¸°å¯Œï¼Œæ¯”å¦‚å…¨æ™¯å¤©çª—ã€æ™ºèƒ½äº’è”ç³»ç»Ÿç­‰ã€‚æ‚¨å¯¹å“ªä¸€æ¬¾æ›´æ„Ÿå…´è¶£å‘¢ï¼Ÿ",
            },
            {
                "role": "user",
                "content": "å¬èµ·æ¥éƒ½ä¸é”™ï¼Œæˆ‘æ¯”è¾ƒåœ¨æ„ç»­èˆªé‡Œç¨‹å’Œæ™ºèƒ½é©¾é©¶è¾…åŠ©ç³»ç»Ÿï¼Œå°ç±³SU7çš„æ™ºèƒ½é©¾é©¶è¾…åŠ©ç³»ç»Ÿæœ‰å“ªäº›äº®ç‚¹ï¼Ÿ",
            },
            {
                "role": "assistant",
                "content": "å°ç±³SU7çš„æ™ºèƒ½é©¾é©¶è¾…åŠ©ç³»ç»Ÿéžå¸¸å…ˆè¿›ã€‚å®ƒé…å¤‡äº†360åº¦å…¨æ™¯å½±åƒã€è½¦é“ä¿æŒè¾…åŠ©ã€è‡ªåŠ¨ç´§æ€¥åˆ¶åŠ¨ç­‰å®‰å…¨åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ”¯æŒOTAè¿œç¨‹å‡çº§ï¼Œè¿™æ„å‘³ç€è½¦è¾†çš„è½¯ä»¶ç³»ç»Ÿå¯ä»¥éšæ—¶æ›´æ–°ï¼Œä¿æŒæœ€æ–°çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚å¯¹äºŽ25å²çš„æ‚¨æ¥è¯´ï¼Œè¿™æ¬¾è½¦çš„ç§‘æŠ€æ„Ÿå’Œæ™ºèƒ½åŒ–é…ç½®åº”è¯¥ä¼šå¾ˆç¬¦åˆæ‚¨çš„éœ€æ±‚ã€‚"
            },
            {
                "role": "user",
                "content": "æˆ‘è¿˜æƒ³äº†è§£ä¸€ä¸‹è‹±ä¼Ÿè¾¾å…¬å¸çš„å•†ä¸šå£åž’ï¼Œæˆ‘ä¹‹å‰çœ‹åˆ°è¿‡ä¸€äº›æ–°é—»ï¼Œä½†æ²¡å¤ªç†è§£ã€‚"
            },
            {
                "role": "assistant",
                "content": "WZHå…ˆç”Ÿï¼Œè‹±ä¼Ÿè¾¾æ˜¯ä¸€å®¶åœ¨å›¾å½¢å¤„ç†å™¨ï¼ˆGPUï¼‰å’Œäººå·¥æ™ºèƒ½é¢†åŸŸå æ®é¢†å…ˆåœ°ä½çš„å…¬å¸ã€‚å®ƒçš„å•†ä¸šå£åž’ä¸»è¦ä½“çŽ°åœ¨æŠ€æœ¯ä¼˜åŠ¿ã€ç”Ÿæ€ç³»ç»Ÿå’Œå¸‚åœºåœ°ä½ä¸‰ä¸ªæ–¹é¢ã€‚é¦–å…ˆï¼Œè‹±ä¼Ÿè¾¾åœ¨GPUæŠ€æœ¯ä¸Šä¸€ç›´å¤„äºŽé¢†å…ˆåœ°ä½ï¼Œå…¶äº§å“å¹¿æ³›åº”ç”¨äºŽæ¸¸æˆã€æ•°æ®ä¸­å¿ƒå’Œè‡ªåŠ¨é©¾é©¶ç­‰é¢†åŸŸã€‚å…¶æ¬¡ï¼Œè‹±ä¼Ÿè¾¾æž„å»ºäº†ä¸€ä¸ªå¼ºå¤§çš„ç”Ÿæ€ç³»ç»Ÿï¼ŒåŒ…æ‹¬è½¯ä»¶ã€å·¥å…·å’Œåˆä½œä¼™ä¼´ï¼Œè¿™ä½¿å¾—å¼€å‘è€…æ›´å®¹æ˜“ä½¿ç”¨å…¶æŠ€æœ¯ï¼Œè¿›ä¸€æ­¥å·©å›ºäº†å¸‚åœºåœ°ä½ã€‚æœ€åŽï¼Œè‹±ä¼Ÿè¾¾åœ¨é«˜æ€§èƒ½è®¡ç®—å’Œäººå·¥æ™ºèƒ½é¢†åŸŸçš„å¸‚åœºä»½é¢å¾ˆé«˜ï¼Œè¿™ä½¿å¾—ç«žäº‰å¯¹æ‰‹å¾ˆéš¾è¿›å…¥ã€‚æ‚¨å¯¹å“ªæ–¹é¢æ›´æ„Ÿå…´è¶£å‘¢ï¼Ÿ"
            },
            {
                "role": "user",
                "content": "é‚£å®ƒçš„æŠ€æœ¯ä¼˜åŠ¿å…·ä½“ä½“çŽ°åœ¨å“ªäº›æ–¹é¢å‘¢ï¼Ÿ"
            },
            {
                "role": "assistant",
                "content": "è‹±ä¼Ÿè¾¾çš„æŠ€æœ¯ä¼˜åŠ¿ä¸»è¦ä½“çŽ°åœ¨å…¶å…ˆè¿›çš„èŠ¯ç‰‡æž¶æž„å’Œå¼ºå¤§çš„è®¡ç®—èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œå…¶æœ€æ–°çš„GPUæž¶æž„èƒ½å¤Ÿæ”¯æŒé«˜æ•ˆçš„å¹¶è¡Œè®¡ç®—ï¼Œè¿™å¯¹äºŽäººå·¥æ™ºèƒ½è®­ç»ƒå’ŒæŽ¨ç†ä»»åŠ¡è‡³å…³é‡è¦ã€‚æ­¤å¤–ï¼Œè‹±ä¼Ÿè¾¾è¿˜ä¸æ–­æŠ•å…¥ç ”å‘ï¼ŒæŽ¨å‡ºæ–°çš„æŠ€æœ¯ï¼Œå¦‚å…‰çº¿è¿½è¸ªå’ŒDLSSï¼ˆæ·±åº¦å­¦ä¹ è¶…é‡‡æ ·ï¼‰æŠ€æœ¯ï¼Œè¿™äº›æŠ€æœ¯å¤§å¹…æå‡äº†å›¾å½¢æ¸²æŸ“çš„æ•ˆçŽ‡å’Œè´¨é‡ã€‚å¯¹äºŽåƒæ‚¨è¿™æ ·å¯¹æŠ€æœ¯æ„Ÿå…´è¶£çš„ç”¨æˆ·æ¥è¯´ï¼Œè‹±ä¼Ÿè¾¾çš„æŠ€æœ¯åˆ›æ–°ç¡®å®žå€¼å¾—å…³æ³¨ã€‚"
            },
            {
                "role": "user",
                "content": "å›žåˆ°æ–°èƒ½æºæ±½è½¦ï¼Œé™¤äº†é…ç½®ï¼Œæˆ‘è¿˜åœ¨æ„æ€§ä»·æ¯”ã€‚å°ç±³SU7å’Œæ¯”äºšè¿ªæ±‰ï¼Œå“ªæ¬¾è½¦çš„æ€§ä»·æ¯”æ›´é«˜å‘¢ï¼Ÿ"
            },
            {
                "role": "assistant",
                "content": "WZHå…ˆç”Ÿï¼Œæ€§ä»·æ¯”æ˜¯ä¸€ä¸ªå¾ˆç»¼åˆçš„è€ƒé‡å› ç´ ã€‚å°ç±³SU7çš„ä»·æ ¼ç›¸å¯¹è¾ƒä¸ºäº²æ°‘ï¼Œå®ƒçš„æ™ºèƒ½åŒ–é…ç½®å’Œæ€§èƒ½è¡¨çŽ°éƒ½å¾ˆä¸é”™ï¼Œå¯¹äºŽ25å²çš„å¹´è½»ç”¨æˆ·æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªæ€§ä»·æ¯”å¾ˆé«˜çš„é€‰æ‹©ã€‚æ¯”äºšè¿ªæ±‰è™½ç„¶ä»·æ ¼ç¨é«˜ï¼Œä½†å®ƒçš„ç»­èˆªé‡Œç¨‹æ›´é•¿ï¼Œå“ç‰Œå£ç¢‘ä¹Ÿå¾ˆå¥½ï¼Œå¦‚æžœæ‚¨æ›´æ³¨é‡è½¦è¾†çš„å“è´¨å’Œç¨³å®šæ€§ï¼Œæ¯”äºšè¿ªæ±‰ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„é¢„ç®—å’Œéœ€æ±‚æ¥å†³å®šã€‚"
            },
            {
                "role": "user",
                "content": "å¥½çš„ï¼Œè°¢è°¢ä½ çš„å»ºè®®ï¼Œæˆ‘ä¼šå†è€ƒè™‘ä¸€ä¸‹ã€‚å¯¹äº†ï¼Œä½ è¿˜èƒ½å¸®æˆ‘å…³æ³¨ä¸€ä¸‹è‹±ä¼Ÿè¾¾çš„æœ€æ–°åŠ¨æ€å—ï¼Ÿ"
            },
            {
                "role": "assistant",
                "content": "å½“ç„¶å¯ä»¥ï¼ŒWZHå…ˆç”Ÿã€‚æˆ‘ä¼šä¸ºæ‚¨æŒç»­å…³æ³¨è‹±ä¼Ÿè¾¾çš„æœ€æ–°åŠ¨æ€ï¼ŒåŒ…æ‹¬æŠ€æœ¯å‘å¸ƒã€å¸‚åœºåŠ¨æ€å’Œè¡Œä¸šæ–°é—»ã€‚å¦‚æžœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œéšæ—¶å¯ä»¥é—®æˆ‘ã€‚"
            }
        ]
        blob = ChatBlob(messages=messages)
        bid = user.insert(blob)
        print("Start processing...")
        user.flush()
        print("\n--------------\nBelow is your profile:")
        print(user.profile(need_json=True))
        print("\n--------------\nYou can use Memobase Event to recent details of the user:")
        for e in user.event():
            print("ðŸ“…", e.created_at.astimezone().strftime("%Y-%m-%d %H:%M:%S"))
            for i in e.event_data.profile_delta:
                print(
                    "-", i.attributes["topic"], i.attributes["sub_topic"], i.content, sep="::"
                )

        print(
            "\n--------------\nYou can use Memobase Context to get a memory prompt and insert it into your prompt:"
        )
        print(
            f"""```
        {user.context()}
        ```
        """
        )
        return user
    
if __name__=="__main__":
    config_path="/data/wzh_fd/workspace/tiny-mm-rag-agent/config/config.yaml"
    with open(config_path,'r',encoding="utf-8") as f:
        config=yaml.safe_load(f)
        config=EasyDict(config)
    memo_base=MemoBase(
        token=config.memobase_token,
        user_id=config.memobase_uid
    )
    mem=memo_base.get_memory()
    logger.info(f"memory => \n{mem}")